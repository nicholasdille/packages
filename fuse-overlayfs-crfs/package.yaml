name: fuse-overlayfs-crfs
description: A fuse-overlayfs plugin for using CRFS for loading lower layers
repo: giuseppe/crfs-plugin
tags:
  - container
files:
- name: Dockerfile
  content: |
    FROM ubuntu:20.04
    ENV DEBIAN_FRONTEND=noninteractive
    RUN apt-get update \
     && apt-get -y install \
            build-essential \
            autoconf \
            autogen \
            clang \
            pkgconf \
            libfuse3-dev \
            golang \
            ca-certificates \
            git \
            make
install:
  docker: true
  script: |-
    require fuse-overlayfs

    get_file fuse-overlayfs-crfs Dockerfile | \
        docker build --tag fuse-overlay-crfs -

    build_containerized fuse-overlay-crfs <<EOF
    git clone https://github.com/giuseppe/crfs-plugin
    cd crfs-plugin
    make
    make install
    EOF

    ${SUDO} mkdir --parents "${TARGET_BASE}/libexec/fuse-overlayfs"
    docker cp "${container_name}:/usr/local/libexec/fuse-overlayfs/crfs-plugin.so" - | \
        tar -x --to-stdout | \
        TARGET_BIN="${TARGET_BASE}/libexec/fuse-overlayfs" store_file crfs-plugin.so

    docker image rm -f fuse-overlay-crfs
