on:
  push:
    branches:
    - master
    paths:
    - pkgctl.sh
    - aws-cli/package.yaml
    - aws-cli2/package.yaml

name: Debug package

jobs:
  build:
    name: Debug package
    runs-on: ubuntu-latest
    steps:

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Debug package
        env:
          TARGET_BASE: /tmp
          DOCKER_BUILDKIT: 1
          PACKAGE: aws-cli
        run: |
          echo "Testing package ${PACKAGE}"
          docker build --target ubuntu --tag test-package:ubuntu .
          docker ps --filter name="test-${PACKAGE}" --all --quiet | xargs -r docker rm -f
          docker run -d --name "test-${PACKAGE}" --env GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }} --mount=type=bind,src=/var/run/docker.sock,dst=/var/run/docker.sock test-package:ubuntu
          docker exec "test-${PACKAGE}" bash -c "curl -sL https://pkg.dille.io/pkgctl.sh | bash -s cache"
          docker exec "test-${PACKAGE}" bash -c "curl -sL https://pkg.dille.io/pkgctl.sh | bash -s install docker"
          docker exec "test-${PACKAGE}" bash -c "curl -sL https://pkg.dille.io/pkgctl.sh | bash -s install ${PACKAGE}"
          docker rm -f "test-${PACKAGE}"
